import{dJ as e,dK as a,j as i,F as t,R as s,C as l,I as n,t as r,a5 as d,ay as o,dL as c,dM as h,dk as u,dN as m,a as x,n as j,E as p,r as g,m as y,s as f,dh as S,da as v,dO as w,dP as k,aL as C,cw as b,D as I,h as z,A as T}from"./index-DuGHnWSh.js";import{i as A,c as L}from"./vendor-DnNJsrFE.js";import{S as D,E as P}from"./Pagination-4eRtu2vp.js";import{F as _,D as H}from"./Table-BHFuAB9g.js";import{R as N}from"./ContainerOutlined-CaQKim2e.js";import{d as $}from"./dayjs.min-NR93IlBy.js";import"./id-BaT3o_TC.js";import{L as Y}from"./index-C6IEzWZL.js";import{R as E}from"./DeleteOutlined-CkmrN41Q.js";import{S as J}from"./index-3xIavl8F.js";import{R as O}from"./SaveOutlined-BoQBxI5C.js";import{T as B}from"./index-BU4HBZE0.js";import{H as M}from"./History-OPj-U_LL.js";import"./index-DjelRtRM.js";import"./progress-DhH2LDwF.js";import"./index-CO9scbey.js";import"./Collapse-BvAcQKVj.js";import"./BookOutlined-CgVSmwOJ.js";const F=()=>{const[c,h]=A(),[u,m]=L.useState(""),[x,j]=L.useState(""),[p,g]=L.useState(""),[y,f]=L.useState(1),[S,v]=L.useState(10),[w,k]=L.useState(""),[C,b]=L.useState(""),{data:I}=e(),z=I?.homebases.map(e=>({value:e.id,label:e.name})),T=I?.grades.map(e=>({value:e.id,label:e.name})),P=I?.classes.map(e=>({value:e.id,label:e.name})),{data:$}=a({page:y,limit:S,search:C,homebaseId:u,gradeId:x,classId:p});L.useEffect(()=>{const e=setTimeout(()=>{b(w)},500);return()=>{clearTimeout(e)}},[w]);const Y=[{title:"No",dataIndex:"index",key:"index",render:(e,a,i)=>(y-1)*S+i+1},{title:"Satuan",dataIndex:"homebase",key:"homebase"},{title:"NIS",dataIndex:"nis",key:"nis"},{title:"Data Siswa",dataIndex:"name",key:"name",render:(e,a)=>i.jsxs(t,{vertical:!0,align:"start",children:[i.jsx(r.Text,{strong:!0,children:e}),i.jsxs(d,{color:"blue",children:["Tingkat ",a.grade," - Kelas ",a.class]})]})},{title:"Aksi",key:"action",render:e=>i.jsx(H.Button,{menu:{items:[{key:"detail",label:"Detail Hafalan",icon:i.jsx(N,{})},{key:"add",label:"Tambah Hafalan",icon:i.jsx(o,{})}],onClick:({key:a})=>((e,{key:a})=>{switch(a){case"detail":h({view:"detail",studentid:e.userid,name:e.name.replace(/\s+/g,"-")});break;case"add":h({view:"form",periodeId:e.periode_id,studentid:e.userid,name:e.name.replace(/\s+/g,"-")})}})(e,{key:a})},children:"Pilihan Aksi"})}];return i.jsxs(t,{vertical:!0,gap:"middle",children:[i.jsxs(s,{gutter:[10,10],children:[i.jsx(l,{xs:24,md:12,lg:6,children:i.jsx(n.Search,{style:{minWidth:100},placeholder:"Cari Siswa ...",value:w,onChange:e=>k(e.target.value),allowClear:!0})}),i.jsx(l,{xs:24,md:12,lg:6,children:i.jsx(D,{style:{width:"100%"},placeholder:"Pilih Satuan",options:z,virtual:!1,allowClear:!0,onChange:e=>m(e)})}),i.jsx(l,{xs:24,md:12,lg:6,children:i.jsx(D,{style:{width:"100%"},placeholder:"Pilih Tingkat",options:T,virtual:!1,allowClear:!0,onChange:e=>j(e)})}),i.jsx(l,{xs:24,md:12,lg:6,children:i.jsx(D,{style:{width:"100%"},placeholder:"Pilih Kelas",options:P,virtual:!1,allowClear:!0,onChange:e=>g(e)})})]}),i.jsx(_,{rowKey:"userid",columns:Y,dataSource:$?.students,pagination:{size:"small",current:y,pageSize:S,total:$?.totalData,showSizeChanger:!0,pageSizeOptions:["10","20","50","100"],showTotal:(e,a)=>`${a[0]}-${a[1]} dari ${e}`,onChange:(e,a)=>{f(e),v(a)}},scroll:{x:"max-content"}})]})};$.locale("id");const{Text:K}=r,R=({student:e,onEdit:a,onDeleteSurah:s,onDeleteJuz:l,isDeleting:n})=>e.records&&0!==e.records.length?i.jsx(t,{vertical:!0,gap:"middle",children:e.records.map(r=>i.jsx(x,{type:"inner",title:`Hafalan ${r.JuzName}`,extra:i.jsx(p,{icon:i.jsx(E,{}),type:"text",danger:!0,onClick:()=>y.confirm({title:`Hapus Seluruh Hafalan ${r.JuzName}?`,content:`Semua data hafalan surah di dalam ${r.JuzName} untuk siswa ini akan dihapus secara permanen.`,okText:"Ya, Hapus",cancelText:"Batal",confirmLoading:n,onOk:()=>l(e,r)}),children:"Hapus"},"delete"),children:i.jsx(Y,{dataSource:r.verses,renderItem:l=>i.jsx(Y.Item,{actions:[i.jsx(p,{icon:i.jsx(g,{}),type:"text",onClick:()=>a(l),children:"Edit"},"edit"),i.jsx(p,{icon:i.jsx(E,{}),type:"text",danger:!0,onClick:()=>y.confirm({title:"Anda yakin?",content:`Hapus hafalan ${l.name} pada ${$(l.date).format("DD MMM YYYY")}?`,onOk:()=>s(e,l),okText:"Ya, Hapus",cancelText:"Batal",confirmLoading:n}),children:"Hapus"},"delete")],children:i.jsx(Y.Item.Meta,{title:i.jsx(t,{justify:"space-between",children:i.jsx(K,{children:l.name})}),description:i.jsxs(t,{vertical:!0,children:[i.jsxs(K,{children:["Ayat ",l.from_ayat," - ",l.to_ayat," | Baris"," ",l.from_line," - ",l.to_line]}),i.jsxs(K,{type:"secondary",children:["Tanggal: ",$(l.date).format("DD MMMM YYYY")]}),i.jsxs(K,{type:"secondary",children:["Penguji: ",l.examiner||"N/A"]})]})})})})},r.id))}):i.jsx(P,{description:"Tidak ada detail hafalan untuk ditampilkan"}),G=()=>{const[e,a]=L.useState(1),[r,d]=L.useState(10),[o,p]=L.useState(""),[g,y]=L.useState(null),[S,v]=L.useState(!1),[w,k]=L.useState(null),[C,{isLoading:b}]=c(),[I,{isLoading:z}]=h(),{data:T}=u({page:"",limit:"",search:""}),{data:A,isLoading:P,isFetching:H}=m({page:e,limit:r,search:o,type:g}),N=e=>{k(e),v(!0)},Y=async(e,a)=>{try{await C({userid:e.userid,juzId:a.id}).unwrap(),f.success(`Seluruh hafalan ${a.JuzName} berhasil dihapus`)}catch(i){f.error(i.data?.message||"Gagal menghapus laporan juz")}},E=async(e,a)=>{try{await I({userid:e.userid,surahId:a.id,date:$(a.date).format("YYYY-MM-DD")}).unwrap(),f.success(`Hafalan ${a.name} berhasil dihapus`)}catch(i){f.error(i.data?.message||"Gagal menghapus laporan surah")}},J=[{title:"Nama Siswa",key:"student",render:(e,a)=>i.jsxs("div",{children:[i.jsx(K,{strong:!0,children:a.name}),i.jsx("br",{}),i.jsxs(K,{type:"secondary",children:["NIS: ",a.nis]})]})},{title:"Kelas",key:"class",render:(e,a)=>a.classname}];return i.jsxs(t,{vertical:!0,gap:"large",children:[i.jsx(x,{children:i.jsxs(s,{gutter:[16,16],children:[i.jsx(l,{xs:24,md:12,children:i.jsx(n.Search,{placeholder:"Cari nama atau NIS siswa...",onSearch:e=>{p(e),a(1)},allowClear:!0})}),i.jsx(l,{xs:24,md:12,children:i.jsx(D,{placeholder:"Filter berdasarkan tipe",style:{width:"100%"},onChange:e=>{y(e),a(1)},allowClear:!0,options:T?.map(e=>({value:e.id,label:e.name})),virtual:!1})})]})}),i.jsx(j,{spinning:P||H||z||b,children:i.jsx(x,{children:i.jsx(_,{columns:J,dataSource:A?.report,loading:P||H,rowKey:"nis",pagination:{current:e,pageSize:r,total:A?.totalData,onChange:(e,i)=>{a(e),d(i)},showSizeChanger:!0},expandable:{expandedRowRender:e=>i.jsx(R,{student:e,onEdit:N,onDeleteSurah:E,onDeleteJuz:Y,isDeleting:z||b}),rowExpandable:e=>e.records&&e.records.length>0},scroll:{x:"max-content"}})})})]})},{Title:q,Text:U}=r,{Option:W}=D,Q=({name:e,userid:a,onBack:n})=>{const[r]=A(),d=r.get("periodeId"),o=e?e.replace(/-/g," "):"Student",[c,h]=L.useState(null),[m,j]=L.useState(null),[g,y]=L.useState([]),[z,T]=L.useState(null),[P,H]=L.useState(null),[N,$]=L.useState([]),[Y,M]=L.useState(null),[F,K]=L.useState(null),[R,G]=L.useState(null),[Q,V]=L.useState(null),[X,Z]=L.useState([]),[ee,ae]=L.useState({}),{data:ie,isLoading:te}=u({page:"",limit:"",search:""}),{data:se,isLoading:le}=S({page:"",limit:"",search:""}),{data:ne,isLoading:re}=v({page:"",limit:"",search:""}),{data:de,isLoading:oe}=w(),[ce,{isLoading:he,isSuccess:ue,isError:me}]=k(),xe=N.find(e=>e.id===P),je=(e,a,i,t)=>{ae(s=>{const l={...s};return l[a]||(l[a]={category_id:a,indicators:{}}),"category"===e?l[a].poin=t:"indicator"===e&&(l[a].indicators[i]={indicator_id:i,poin:t}),l})};L.useEffect(()=>{ue&&(h(null),j(null),y([]),T(null),H(null),$([]),M(null),K(null),G(null),V(null),Z([]),ae({}))},[ue]);const pe=[{title:"Surah",dataIndex:"fromSurahName",key:"surah",align:"center"},{title:"From Ayat",dataIndex:"fromAyat",key:"fromAyat",align:"center"},{title:"To Ayat",dataIndex:"toAyat",key:"toAyat",align:"center"},{title:"From Line",dataIndex:"fromLine",key:"fromLine",align:"center"},{title:"To Line",dataIndex:"toLine",key:"toLine",align:"center"},{title:"Action",key:"action",align:"center",render:(e,a)=>i.jsx(p,{type:"primary",danger:!0,icon:i.jsx(E,{}),onClick:()=>{return e=a.key,Z(a=>a.filter(a=>a.key!==e)),void f.info("Surah removed.");var e}})}],ge=[{title:"Category",dataIndex:"name",key:"category",width:"20%"},{title:"Indicator",key:"indicator",width:"60%",render:(e,a)=>i.jsx(J,{direction:"vertical",style:{width:"100%"},children:a.indicators&&a.indicators.filter(e=>null!==e).length>0?a.indicators.filter(e=>null!==e).map(e=>i.jsxs(s,{align:"middle",justify:"space-between",style:{width:"100%"},children:[i.jsx(l,{children:i.jsx(U,{children:e.name})}),i.jsx(l,{children:i.jsx(B,{placeholder:"Score",min:0,max:100,onChange:i=>je("indicator",a.id,e.id,i),style:{width:120}})})]},e.id)):i.jsx(U,{type:"secondary",children:"No indicators for this category."})})},{title:"Final Score",key:"score",width:"20%",align:"center",render:(e,a)=>i.jsx(B,{placeholder:"Total",min:0,max:100,onChange:e=>je("category",a.id,null,e),style:{width:100}})}];return i.jsxs(t,{vertical:!0,gap:"middle",children:[i.jsxs(J,{children:[i.jsx(p,{shape:"circle",icon:i.jsx(C,{}),onClick:n}),i.jsxs(q,{style:{margin:0},level:5,children:["Penilaian Tahfiz: ",o]})]}),i.jsxs(s,{gutter:[24,24],children:[i.jsx(l,{xs:24,lg:12,children:i.jsxs(J,{direction:"vertical",size:"large",style:{width:"100%"},children:[i.jsx(x,{title:"Pilihan Hafalan",children:i.jsxs(J,{direction:"vertical",style:{width:"100%"},children:[i.jsx(U,{strong:!0,children:"Tambah Juz (Bulk)"}),i.jsxs(s,{gutter:8,children:[i.jsx(l,{flex:"auto",children:i.jsx(D,{mode:"multiple",allowClear:!0,style:{width:"100%"},placeholder:"Pilih 1 atau lebih Juz",loading:re,value:g,onChange:y,virtual:!1,children:ne?.map(e=>i.jsx(W,{value:e.id,children:e.name},e.id))})}),i.jsx(l,{children:i.jsx(p,{type:"primary",icon:i.jsx(b,{}),onClick:()=>{if(0===g.length)return void f.warning("Please select at least one Juz to add.");const e=[];g.forEach(a=>{const i=ne?.find(e=>e.id===a);i&&i.surah&&i.surah.forEach(a=>{X.some(e=>e.fromSurahName===a.surah)||e.push({key:`${i.id}-${a.surah_id}`,juzId:i.id,fromSurah:a.surah_id,fromSurahName:a.surah,fromAyat:a.from_ayat,toAyat:a.to_ayat,fromLine:1,toLine:a.lines})})}),Z(a=>[...a,...e]),y([]),f.success(`${e.length} surah(s) added successfully.`)}})})]}),i.jsx(I,{}),i.jsx(U,{strong:!0,children:"Tambah Surah (Spesifik)"}),i.jsxs(s,{gutter:[8,16],children:[i.jsx(l,{xs:24,sm:12,children:i.jsx(D,{style:{width:"100%"},placeholder:"1. Pilih Juz",loading:re,onChange:e=>{const a=ne?.find(a=>a.id===e);T(a),$(a?.surah||[]),H(null),M(null),K(null),G(null),V(null)},virtual:!1,allowClear:!0,children:ne?.map(e=>i.jsx(W,{value:e.id,children:e.name},e.id))})}),i.jsx(l,{xs:24,sm:12,children:i.jsx(D,{style:{width:"100%"},placeholder:"2. Pilih Surah",disabled:!z,value:P,onChange:H,virtual:!1,allowClear:!0,children:N.map(e=>i.jsx(W,{value:e.id,children:e.surah},e.id))})})]}),i.jsxs(s,{gutter:[8,16],children:[i.jsx(l,{xs:24,sm:12,children:i.jsx(D,{style:{width:"100%"},placeholder:"3. Dari Ayat",disabled:!xe,value:Y,onChange:M,virtual:!1,allowClear:!0,children:xe&&Array.from({length:xe.to_ayat-xe.from_ayat+1},(e,a)=>xe.from_ayat+a).map(e=>i.jsx(W,{value:e,children:e},e))})}),i.jsx(l,{xs:24,sm:12,children:i.jsx(D,{style:{width:"100%"},placeholder:"4. Sampai Ayat",disabled:!Y,value:F,onChange:K,virtual:!1,allowClear:!0,children:xe&&Array.from({length:xe.to_ayat-Y+1},(e,a)=>Y+a).map(e=>i.jsx(W,{value:e,children:e},e))})})]}),i.jsxs(s,{gutter:[8,16],children:[i.jsx(l,{xs:24,sm:12,children:i.jsx(D,{style:{width:"100%"},placeholder:"5. Dari Baris",disabled:!F,value:R,onChange:G,virtual:!1,allowClear:!0,children:xe&&Array.from({length:xe.lines},(e,a)=>a+1).map(e=>i.jsx(W,{value:e,children:e},e))})}),i.jsx(l,{xs:24,sm:12,children:i.jsx(D,{style:{width:"100%"},placeholder:"6. Sampai Baris",disabled:!R,value:Q,onChange:V,virtual:!1,allowClear:!0,children:xe&&Array.from({length:xe.lines-R+1},(e,a)=>R+a).map(e=>i.jsx(W,{value:e,children:e},e))})})]}),i.jsx(p,{type:"primary",onClick:()=>{Z(e=>[...e,{key:`${z.id}-${xe.surah_id}-${Y}`,juzId:z.id,fromSurah:xe.surah_id,fromSurahName:xe.surah,fromAyat:Y,toAyat:F,fromLine:R,toLine:Q}]),H(null),M(null),K(null),G(null),V(null)},disabled:!Q,block:!0,children:"Simpan Surah"})]})}),i.jsx(x,{title:"Detail Penilaian",children:i.jsxs(s,{gutter:[16,16],children:[i.jsx(l,{xs:24,md:12,children:i.jsx(D,{placeholder:"Pilih Jenis Penilaian",style:{width:"100%"},loading:te,value:c,onChange:h,virtual:!1,children:ie?.map(e=>i.jsx(W,{value:e.id,children:e.name},e.id))})}),i.jsx(l,{xs:24,md:12,children:i.jsx(D,{placeholder:"Pilih Penguji",style:{width:"100%"},loading:le,value:m,onChange:j,virtual:!1,children:se?.map(e=>i.jsx(W,{value:e.id,children:e.name},e.id))})})]})})]})}),i.jsx(l,{xs:24,lg:12,children:i.jsx(x,{title:"Indikator Penilaian",children:i.jsx(_,{bordered:!0,size:"small",pagination:!1,dataSource:de,columns:ge,loading:oe,rowKey:"id",scroll:{x:"max-content"}})})})]}),i.jsx(I,{}),i.jsx(q,{level:5,children:"Daftar Surah"}),i.jsx(_,{bordered:!0,dataSource:X,columns:pe,pagination:{pageSize:5},locale:{emptyText:"No surahs have been added yet."},scroll:{x:"max-content"}}),i.jsx(s,{justify:"end",style:{marginTop:"24px"},children:i.jsx(l,{children:i.jsx(p,{type:"primary",icon:i.jsx(O,{}),loading:he,disabled:0===X.length,onClick:async()=>{if(!c||!m||0===X.length)return void f.error("Assessment Type, Examiner, and at least one Surah are required.");const e=Object.values(ee).map(e=>({category_id:e.category_id,poin:e.poin??0,indicators:Object.values(e.indicators).map(e=>({...e,poin:e.poin??0}))})),i={userid:parseInt(a),periodeId:parseInt(d),surahs:X.map(({fromSurah:e,fromAyat:a,toAyat:i,fromLine:t,toLine:s,juzId:l})=>({fromSurah:e,fromAyat:a,toAyat:i,fromLine:t,toLine:s,juzId:l})),examiner:parseInt(m),poin:{type_id:parseInt(c),categories:e}};try{const e=await ce(i).unwrap();f.success(e.message||"Scores saved successfully!")}catch(t){f.error(t.data?.message||"Failed to save scores.")}},children:"Simpan"})})})]})},V=()=>{const[e,a]=A(),t=e.get("view"),s=e.get("studentid"),l=e.get("name"),n=[{label:"Setor Hafalan",key:"1",children:i.jsx(F,{})},{label:"Laporan",key:"2",children:i.jsx(G,{})}],r=()=>{a({})};return"form"===t?i.jsx(z,{title:"Hafalan Tahfiz",levels:["tahfiz"],children:i.jsx(Q,{name:l,userid:s,onBack:r})}):"detail"===t?i.jsx(z,{title:"Hafalan Tahfiz",levels:["tahfiz"],children:i.jsx(M,{name:l,userid:s,onBack:r})}):i.jsx(z,{title:"Hafalan Tahfiz",levels:["tahfiz"],children:i.jsx(T,{defaultActiveKey:"1",centered:!0,items:n})})};export{V as default};
