import{j as e,e as T,r as d,c as B,ae as H,af as P,d as A,a as F,ag as O,ah as G,a5 as J,ai as K}from"./index-Bk0R0AbM.js";const R=t=>{if(!t&&t!==0)return"--:--:--";const n=Math.floor(t/3600),m=Math.floor(t%3600/60),l=t%60;return`${String(n).padStart(2,"0")}:${String(m).padStart(2,"0")}:${String(l).padStart(2,"0")}`},D=({name:t,user:n,examid:m,timeLeft:l,isExamStarted:u})=>e.jsx("div",{className:"container-fluid bg-primary text-white",children:e.jsx("div",{className:"container p-2",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"card-title mb-0",children:t.replace(/-/g," ")}),e.jsxs("small",{children:["Nama: ",n.name," | Kelas: ",n.class]})]}),e.jsx("div",{className:"d-flex align-items-center gap-3",children:u&&e.jsx("div",{className:"h3 m-0",children:R(l)})})]})})}),U=({currentPage:t,questionsLength:n,isLoading:m,onPrevious:l,onNext:u,onReset:x,onFinish:f,questionsData:j,answers:s})=>{const r=()=>j.every(y=>{const i=s[y.id];return y.qtype===2?!!(i!=null&&i.essay&&i.essay.trim()!==""):!!(i!=null&&i.mc)});return e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{className:"btn btn-sm btn-primary",onClick:l,disabled:t===1||m,children:e.jsx("i",{className:"bi bi-chevron-double-left"})}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",disabled:!0,children:`Pertanyaan No ${t}`}),e.jsx("button",{className:"btn btn-sm btn-primary",onClick:u,disabled:t===n||m,children:e.jsx("i",{className:"bi bi-chevron-double-right"})})]}),e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{className:"btn btn-sm btn-warning",onClick:x,disabled:m,children:[e.jsx("i",{className:"bi bi-recycle"})," Sync"]}),e.jsxs("button",{className:"btn btn-sm btn-danger",onClick:f,disabled:!r(),title:r()?"Selesaikan ujian":"Semua pertanyaan harus dijawab",children:[e.jsx("i",{className:"bi bi-check-circle"})," Selesaikan Ujian"]})]})]})},V=t=>({__html:t}),z=({question:t})=>e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsx("p",{className:"card-text",dangerouslySetInnerHTML:V(t)})})}),W=t=>({__html:t}),X=({currentQuestion:t,answers:n,essay:m,setEssay:l,currentPage:u,handleSubmit:x,isLoadingAnswer:f})=>{const j=()=>{var s;if(!t)return null;if(t.qtype===2){const r=((s=n[t.id])==null?void 0:s.essay)||"";return e.jsx("div",{className:"answer-options",children:e.jsx("textarea",{className:"form-control",rows:"4",placeholder:"Ketikkan jawabanmu disini...",value:r||m,onChange:y=>l(y.target.value),onBlur:()=>x()})})}return e.jsx("div",{className:"d-flex flex-column gap-2",children:t.choices&&t.choices.map((r,y)=>{var c;const i=(c=n[t.id])==null?void 0:c.mc,p=i&&i===r.key;return e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"radio",name:`question-${u}`,id:`option-${r.key}`,value:r.key,checked:p,onChange:b=>x(b.target.value)}),e.jsx("label",{className:"form-check-label pointer",htmlFor:`option-${r.key}`,children:e.jsx("span",{dangerouslySetInnerHTML:W(r.text)})})]},y)})})};return e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:f?e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):j()})})},Y=({questionsData:t,currentPage:n,answers:m,isLoading:l,onQuestionNumberClick:u})=>e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"d-flex justify-content-center flex-wrap gap-2",children:t.map((x,f)=>{const j=x==null?void 0:x.id,s=m[j],r=x.qtype===2?!!(s!=null&&s.essay&&s.essay.trim()!==""):!!(s!=null&&s.mc&&s.mc!=="");return e.jsx("button",{className:`btn btn-sm ${n===f+1?"btn-primary":r?"btn-danger":"btn-outline-primary"}`,onClick:()=>u(f),disabled:l,children:f+1},f)})})})}),Z=({questionsData:t,currentPage:n,onNext:m,onPrevious:l,onQuestionNumberClick:u,onReset:x,onFinish:f})=>{const{examid:j}=T(),s=t[n-1]||{},[r,y]=d.useState(""),[i,p]=d.useState(""),[c,b]=d.useState({}),{user:k}=B(S=>S.auth),{data:N,isLoading:C}=H({student:k.user_id,exam:j}),[E,{isLoading:_,isSuccess:I,isError:v,reset:w}]=P();console.log(N),d.useEffect(()=>{var S;if(N){const h={};N.forEach(a=>{a.question_id&&(h[a.question_id]={id:a.id,mc:a.mc||null,essay:a.essay||null,point:a.point||0,qtype:a.qtype})}),b(h),(S=h[s.id])!=null&&S.mc&&p(h[s.id].mc)}},[N,s]),d.useEffect(()=>{c[s.id]?s.qtype===2?y(c[s.id].essay||""):p(c[s.id].mc||""):(p(""),y(""))},[s,c]);const q=async(S=null)=>{var o;if(!s)return;const h=s.qtype===2?r:S,a={id:((o=c[s.id])==null?void 0:o.id)||null,student:k.user_id,exam:j,question:s.id,mc:s.qtype===2?null:h,essay:s.qtype===2?h:null};A.promise(E(a).unwrap().then(g=>(g.id&&b($=>({...$,[s.id]:{...$[s.id],id:g.id,mc:s.qtype===2?null:h,essay:s.qtype===2?h:null}})),g.message)),{loading:"Meyimpan data...",success:g=>g,error:g=>g.data.message})},L=async()=>{s.qtype===2&&r&&await q(),m()},M=async()=>{s.qtype===2&&r&&await q(),l()};return d.useEffect(()=>{v&&w(),I&&w()},[v,w,I]),e.jsxs("div",{className:"container-fluid mt-2",children:[e.jsx(U,{currentPage:n,questionsLength:t.length,isLoading:_,onPrevious:M,onNext:L,onReset:x,onFinish:f,questionsData:t,answers:c}),e.jsxs("div",{className:"row g-2",children:[e.jsx("div",{className:"col-lg-5 col-12",children:e.jsx(z,{question:s.question})}),e.jsx("div",{className:"col-lg-5 col-12",children:e.jsx(X,{currentQuestion:s,answers:c,essay:r,setEssay:y,currentPage:n,handleSubmit:q,isLoadingAnswer:C})}),e.jsx("div",{className:"col-lg-2 col-12",children:e.jsx(Y,{questionsData:t,currentPage:n,answers:c,isLoading:_,onQuestionNumberClick:u})})]})]})},se=()=>{const{name:t,examid:n,token:m}=T(),l=F(),{user:u}=B(a=>a.auth),{data:x={},refetch:f,isLoading:j,error:s}=O({examid:n}),{exam:r,banks:y,questions:i}=x,[p,c]=d.useState([]),[b,k]=d.useState(1),[N,C]=d.useState(null),[E,_]=d.useState(!1),[I]=G(),{data:v,error:w}=J({exam:n,student:u.user_id},{skip:!n||!u.user_id});d.useEffect(()=>{s&&(A.error("Anda tidak memiliki akses ke ujian ini"),l("/"))},[s,l]),d.useEffect(()=>{w&&(A.error("Anda belum memulai ujian ini"),l("/siswa-daftar-ujian"))},[w,l]),d.useEffect(()=>{if(v&&r&&v.start_time){const a=new Date(v.start_time).getTime(),o=new Date().getTime(),g=Math.floor((o-a)/1e3),$=r.duration*60,Q=Math.max(0,$-g);Q<=0?h():(C(Q),_(!0))}},[v,r]),d.useEffect(()=>{if(!E||!N)return;const a=setInterval(()=>{C(o=>o<=1?(clearInterval(a),h(),0):o-1)},1e3);return()=>clearInterval(a)},[E,N]);const q=()=>{b<p.length&&k(b+1)},L=()=>{b>1&&k(b-1)},M=a=>{k(a+1)},S=()=>{localStorage.removeItem("questions"),f(),i&&Array.isArray(i)&&(localStorage.setItem("questions",JSON.stringify({questions:i})),c(i))},h=async()=>{A.promise(I({id:v.id,exam:n}).unwrap(),{loading:"Submitting exam...",success:a=>(A.success("Exam submitted successfully"),l("/siswa-daftar-ujian"),a.message||"Exam submitted successfully"),error:a=>{var o;return`Failed to submit exam: ${((o=a.data)==null?void 0:o.message)||a.message}`}})};return d.useEffect(()=>{if(!i)return;const a=localStorage.getItem("questions");if(a)try{const o=JSON.parse(a);Array.isArray(o.questions)?c(o.questions):c([])}catch(o){console.error("Error parsing stored questions:",o),c([])}else i&&Array.isArray(i)&&(localStorage.setItem("questions",JSON.stringify({questions:i})),c(i))},[i]),j?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh"},children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):e.jsxs("div",{style:{height:"100vh"},className:"bg-light",children:[e.jsx(K,{title:`Pertanyaan No ${b}`}),e.jsx(D,{name:t,user:u,examid:n,timeLeft:N,isExamStarted:E}),e.jsx(Z,{questionsData:p,currentPage:b,onNext:q,onPrevious:L,onQuestionNumberClick:M,onReset:S,onFinish:h})]})};export{se as default};
