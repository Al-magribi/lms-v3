import{j as e,b as a,b7 as s,b8 as i,e as t,b9 as n,ba as r,aZ as l,M as c}from"./index-DmZz6DJh.js";import{e as d,b as o,u as m}from"./vendor-DfXzdC0j.js";const u=e=>{if(!e&&0!==e)return"--:--:--";const a=Math.floor(e/3600),s=Math.floor(e%3600/60),i=e%60;return`${String(a).padStart(2,"0")}:${String(s).padStart(2,"0")}:${String(i).padStart(2,"0")}`},x=({name:a,user:s,examid:i,timeLeft:t,isExamStarted:n})=>e.jsx("div",{className:"container-fluid bg-primary text-white",children:e.jsx("div",{className:"container p-2",children:e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"card-title mb-0",children:a.replace(/-/g," ")}),e.jsxs("small",{children:["Nama: ",s.name," | Kelas: ",s.class]})]}),e.jsx("div",{className:"d-flex align-items-center gap-3",children:n?null==t?e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("small",{className:"text-white-50",children:"Status"}),e.jsx("div",{className:"h6 m-0 text-warning",children:"Memuat Timer..."})]}):t<=0?e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("small",{className:"text-white-50",children:"Status"}),e.jsx("div",{className:"h6 m-0 text-danger",children:"Waktu Habis"})]}):e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("small",{className:"text-white-50",children:"Waktu Tersisa"}),e.jsx("div",{className:"h3 m-0 fw-bold "+(t<=300?"text-danger":t<=600?"text-warning":"text-light"),children:u(t)}),t<=300&&e.jsx("small",{className:"text-danger fw-bold",children:"âš ï¸ Waktu Hampir Habis!"})]}):e.jsxs("div",{className:"d-flex flex-column align-items-center",children:[e.jsx("small",{className:"text-white-50",children:"Status"}),e.jsx("div",{className:"h6 m-0 text-warning",children:"Memulai Ujian..."})]})})]})})}),h=({currentPage:a,questionsLength:s,isLoading:i,onPrevious:t,onNext:n,onReset:r,onFinish:l,questionsData:c,answers:d})=>{const o=()=>c.every((e=>{const a=d[e.id];return 2===e.qtype?Boolean((null==a?void 0:a.essay)&&""!==a.essay.trim()):Boolean(null==a?void 0:a.mc)}));return e.jsxs("div",{className:"d-flex justify-content-between mb-2",children:[e.jsxs("div",{className:"btn-group",children:[e.jsx("button",{className:"btn btn-sm btn-primary",onClick:t,disabled:1===a||i,children:e.jsx("i",{className:"bi bi-chevron-double-left"})}),e.jsx("button",{className:"btn btn-sm btn-outline-primary",disabled:!0,children:`Pertanyaan No ${a}`}),e.jsx("button",{className:"btn btn-sm btn-primary",onClick:n,disabled:a===s||i,children:e.jsx("i",{className:"bi bi-chevron-double-right"})})]}),e.jsxs("div",{className:"btn-group",children:[e.jsxs("button",{className:"btn btn-sm btn-warning",onClick:r,disabled:i,children:[e.jsx("i",{className:"bi bi-recycle"})," Sync"]}),e.jsxs("button",{className:"btn btn-sm btn-danger",onClick:l,disabled:!o(),title:o()?"Selesaikan ujian":"Semua pertanyaan harus dijawab",children:[e.jsx("i",{className:"bi bi-check-circle"})," Selesaikan Ujian"]})]})]})},j=({question:a})=>{return e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsx("p",{className:"card-text",dangerouslySetInnerHTML:(s=a,{__html:s})})})});var s},g=({currentQuestion:a,answers:s,essay:i,setEssay:t,currentPage:n,handleSubmit:r,isLoadingAnswer:l})=>{return e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:l?e.jsx("div",{className:"text-center",children:e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})})}):a?2===a.qtype?(null==(c=s[a.id])||c.essay,e.jsx("div",{className:"answer-options",children:e.jsx("textarea",{className:"form-control",rows:"4",placeholder:"Ketikkan jawabanmu disini...",value:i,onChange:e=>t(e.target.value),onBlur:()=>r()})})):e.jsx("div",{className:"d-flex flex-column gap-2",children:a.choices&&a.choices.map(((i,t)=>{var l;const c=null==(l=s[a.id])?void 0:l.mc,d=c&&c===i.key;return e.jsxs("div",{className:"form-check",children:[e.jsx("input",{className:"form-check-input",type:"radio",name:`question-${n}`,id:`option-${i.key}`,value:i.key,checked:d,onChange:e=>r(e.target.value)}),e.jsx("label",{className:"form-check-label pointer",htmlFor:`option-${i.key}`,children:e.jsx("span",{dangerouslySetInnerHTML:(o=i.text,{__html:o})})})]},t);var o}))}):null})});var c},f=({questionsData:a,currentPage:s,answers:i,isLoading:t,onQuestionNumberClick:n})=>e.jsx("div",{className:"card",children:e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"d-flex justify-content-center flex-wrap gap-2",children:a.map(((a,r)=>{const l=null==a?void 0:a.id,c=i[l],d=2===a.qtype?Boolean((null==c?void 0:c.essay)&&""!==c.essay.trim()):Boolean((null==c?void 0:c.mc)&&""!==c.mc);return e.jsx("button",{className:"btn btn-sm "+(s===r+1?"btn-primary":d?"btn-danger":"btn-outline-primary"),onClick:()=>n(r),disabled:t,children:r+1},r)}))})})}),b=({questionsData:n,currentPage:r,onNext:l,onPrevious:c,onQuestionNumberClick:m,onReset:u,onFinish:x})=>{const{examid:b}=d(),v=o.useMemo((()=>n[r-1]||{}),[n,r]),[y,N]=o.useState(""),[p,k]=o.useState(""),[w,q]=o.useState({}),{user:S}=a((e=>e.auth)),{data:E,isLoading:L}=s({student:S.id,exam:b}),[M,{isLoading:D,isSuccess:P,isError:A,reset:C}]=i();o.useEffect((()=>{if(E){const e={};E.forEach((a=>{a.question_id&&(e[a.question_id]={id:a.id,mc:a.mc||null,essay:a.essay||null,point:a.point||0,qtype:a.qtype})})),q(e)}}),[E]),o.useEffect((()=>{v&&v.id&&w[v.id]?2===v.qtype?N(w[v.id].essay||""):k(w[v.id].mc||""):(k(""),N(""))}),[null==v?void 0:v.id,null==v?void 0:v.qtype,w]);const T=async(e=null)=>{var a;if(!v)return;const s=2===v.qtype?y:e;if(2===v.qtype&&!s)return;const i={id:(null==(a=w[v.id])?void 0:a.id)||null,student:S.id,exam:b,question:v.id,mc:2===v.qtype?null:s,essay:2===v.qtype?s:null};t.promise(M(i).unwrap().then((e=>(e.id&&q((a=>({...a,[v.id]:{...a[v.id],id:e.id,mc:2===v.qtype?null:s,essay:2===v.qtype?s:null}}))),e.message))),{loading:"Meyimpan data...",success:e=>e,error:e=>e.data.message})};return o.useEffect((()=>{A&&C()}),[A,C]),o.useEffect((()=>{P&&C()}),[P,C]),e.jsxs("div",{className:"container-fluid mt-2",children:[e.jsx(h,{currentPage:r,questionsLength:n.length,isLoading:D,onPrevious:async()=>{2===v.qtype&&y&&await T(),c()},onNext:async()=>{2===v.qtype&&y&&await T(),l()},onReset:u,onFinish:x,questionsData:n,answers:w}),e.jsxs("div",{className:"row g-2",children:[e.jsx("div",{className:"col-lg-5 col-12",children:e.jsx(j,{question:v.question})}),e.jsx("div",{className:"col-lg-5 col-12",children:e.jsx(g,{currentQuestion:v,answers:w,essay:y,setEssay:N,currentPage:r,handleSubmit:T,isLoadingAnswer:L})}),e.jsx("div",{className:"col-lg-2 col-12",children:e.jsx(f,{questionsData:n,currentPage:r,answers:w,isLoading:D,onQuestionNumberClick:m})})]})]})},v=()=>{const{name:s,examid:i,token:u}=d(),h=m(),{user:j}=a((e=>e.auth)),{data:g={},refetch:f,isLoading:v,error:y}=n({examid:i}),{exam:N,banks:p,questions:k}=g,[w,q]=o.useState([]),[S,E]=o.useState(1),[L,M]=o.useState(null),[D,P]=o.useState(!1),[A]=r(),{data:C,error:T,isLoading:$}=l({exam:i,student:null==j?void 0:j.id},{skip:!i||!(null==j?void 0:j.id)});o.useEffect((()=>{y&&(t.error("Anda tidak memiliki akses ke ujian ini"),h("/siswa-daftar-ujian"))}),[y,h]),o.useEffect((()=>{if(C&&N&&C.start_time&&!D&&!$)try{const e=new Date(C.start_time).getTime(),a=(new Date).getTime(),s=Math.floor((a-e)/1e3),i=60*N.duration,n=Math.max(0,i-s);if(n<=0)return void _();M(n),P(!0),t.success(`Ujian dimulai! Waktu tersisa: ${Math.floor(n/60)} menit ${n%60} detik`)}catch(e){console.error("Error calculating timer:",e),t.error("Terjadi kesalahan saat memulai timer")}}),[C,N,$,D]),o.useEffect((()=>{if(T&&!$)return t.error("Anda belum memulai ujian ini"),void h("/siswa-daftar-ujian");if(C&&N&&C.start_time&&!D)try{const e=new Date(C.start_time).getTime(),a=(new Date).getTime(),s=Math.floor((a-e)/1e3),i=60*N.duration,t=Math.max(0,i-s);if(t<=0)return void _();M(t),P(!0)}catch(e){console.error("Error calculating timer:",e),t.error("Terjadi kesalahan saat memulai timer")}}),[C,N,$,T,h,D]),o.useEffect((()=>{if(!D||!L||L<=0)return;const e=setInterval((()=>{M((a=>a<=1?(clearInterval(e),_(),0):(300===a?t.warning("âš ï¸ Waktu tersisa 5 menit!"):60===a&&t.error("ðŸš¨ Waktu tersisa 1 menit!"),a-1)))}),1e3);return()=>clearInterval(e)}),[D,L]);o.useEffect((()=>{0===L&&D&&D&&L<=0&&(t.error("â° Waktu ujian telah habis! Ujian akan diselesaikan otomatis."),_())}),[L,D]),o.useEffect((()=>{const e=e=>{if(D&&L>0)return e.preventDefault(),e.returnValue="Anda sedang mengikuti ujian. Yakin ingin meninggalkan halaman ini?",e.returnValue};return window.addEventListener("beforeunload",e),()=>window.removeEventListener("beforeunload",e)}),[D,L]);const _=async()=>{if(!C||!C.id)return console.error("No log data available for finishing exam"),t.error("Data ujian tidak tersedia"),void h("/siswa-daftar-ujian");t.promise(A({id:C.id,exam:i}).unwrap(),{loading:0===L?"Menyelesaikan ujian otomatis...":"Menyelesaikan ujian...",success:e=>{const a=0===L?"Ujian telah diselesaikan otomatis karena waktu habis":"Ujian berhasil diselesaikan";return t.success(a),h("/siswa-daftar-ujian"),e.message||a},error:e=>{var a;return console.error("Error finishing exam:",e),`Gagal menyelesaikan ujian: ${(null==(a=e.data)?void 0:a.message)||e.message}`}})};return o.useEffect((()=>{if(!k)return;const e=localStorage.getItem("questions");if(e)try{const a=JSON.parse(e);Array.isArray(a.questions)?q(a.questions):q([])}catch(a){console.error("Error parsing stored questions:",a),q([])}else k&&Array.isArray(k)&&(localStorage.setItem("questions",JSON.stringify({questions:k})),q(k))}),[k]),$?e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"spinner-border text-primary mb-3",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("h5",{children:"Memverifikasi Akses Ujian"}),e.jsx("p",{className:"text-muted",children:"Mohon tunggu sebentar..."})]})}):v?e.jsxs("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh"},children:[e.jsx("div",{className:"spinner-border text-primary",role:"status",children:e.jsx("span",{className:"visually-hidden",children:"Loading..."})}),e.jsx("div",{className:"ms-3",children:e.jsx("small",{className:"text-muted",children:"Memuat ujian..."})})]}):N&&C?e.jsxs("div",{style:{height:"100vh"},className:"bg-light",children:[e.jsx(c,{title:`Pertanyaan No ${S}`}),e.jsx(x,{name:s,user:j,examid:i,timeLeft:L,isExamStarted:D}),e.jsx(b,{questionsData:w,currentPage:S,onNext:()=>{S<w.length&&E(S+1)},onPrevious:()=>{S>1&&E(S-1)},onQuestionNumberClick:e=>{E(e+1)},onReset:()=>{localStorage.removeItem("questions"),f(),k&&Array.isArray(k)&&(localStorage.setItem("questions",JSON.stringify({questions:k})),q(k))},onFinish:_,timeLeft:L,isExamStarted:D})]}):e.jsx("div",{className:"d-flex justify-content-center align-items-center",style:{height:"100vh"},children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-danger mb-3",children:e.jsx("i",{className:"bi bi-exclamation-triangle fs-1"})}),e.jsx("h5",{children:"Data Ujian Tidak Ditemukan"}),e.jsx("p",{className:"text-muted",children:N?C?"Data tidak lengkap":"Anda belum memulai ujian ini":"Data ujian tidak tersedia"}),e.jsx("button",{className:"btn btn-primary",onClick:()=>h("/siswa-daftar-ujian"),children:"Kembali ke Daftar Ujian"})]})})};export{v as default};
//# sourceMappingURL=StartPage-B5pveqPO.js.map
